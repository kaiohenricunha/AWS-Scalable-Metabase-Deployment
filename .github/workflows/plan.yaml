name: Plan

env:
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  AWS_DEFAULT_REGION: 'us-west-2'
  RDS_ENDPOINT: ${{ secrets.RDS_ENDPOINT }}
  RDS_PASSWORD: ${{ secrets.RDS_PASSWORD }}
  DB_NAME: ${{ secrets.DB_NAME }}
  DB_USERNAME: ${{ secrets.DB_USERNAME }}
  DB_PORT: ${{ secrets.DB_PORT }}
  TF_VAR_db_name: ${{ secrets.DB_NAME }}
  TF_VAR_db_username: ${{ secrets.DB_USERNAME }}
  TF_VAR_db_port: ${{ secrets.DB_PORT }}
  TF_VAR_rds_endpoint: ${{ secrets.RDS_ENDPOINT }}
  TF_VAR_rds_password: ${{ secrets.RDS_PASSWORD }}

on:
  pull_request:
    branches:
      - main

jobs:
  plan-infra:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v1

      - name: Install Helm
        uses: azure/setup-helm@v1
        with:
          version: v3.7.0

      - name: Terraform Init
        run: |
          cd infra
          terraform init
      - name: Terraform Plan
        run: |
          cd infra
          terraform plan

      - name: Helm Template Metabase
        run: |
          cd infra/stack/metabase
          pwd
          ls -la
          helm repo add pmint93 https://pmint93.github.io/helm-charts
          helm repo update
          helm template metabase pmint93/metabase -n metabase -f rendered-values.yaml \
# --set database.host=${{ secrets.RDS_ENDPOINT }},\
# --set database.port=${{ secrets.DB_PORT }},\
# --set database.dbname=${{ secrets.DB_NAME }},\
# --set database.username=${{ secrets.DB_USERNAME }},\
# --set database.password=${{ secrets.RDS_PASSWORD }},\
# --set ingress.annotations."alb\.ingress\.kubernetes\.io/certificate-arn"=${{ steps.get_cert_arn.outputs.acm_certificate_arn }}
